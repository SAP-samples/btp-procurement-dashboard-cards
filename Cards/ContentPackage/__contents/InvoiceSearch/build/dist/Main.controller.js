sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(e,t,i){"use strict";return e.extend("sap.ariba.InvoiceSearch.Main",{onInit:function(){var e=new t;var i=this.getOwnerComponent().card,a=i.getCombinedParameters().statuses;e.setData({statuses:JSON.parse(a)});this.getView().setModel(e,"statusList");this._initViewModel();var r=new t;this.getView().setModel(r,"invoices");r.refresh(true)},_initViewModel:function(){var e=new t({busy:false,invoiceIdFilter:null,invDateFilter:null,createdByMeFilter:null,statusFilter:null,supplierIdFilter:null});this.getView().setModel(e,"oViewModel")},_getFilter:function(e){var t=e.getCombinedParameters().realm,i="$filter=Realm eq '"+t+"'",a=this.getView().getModel("oViewModel");if(a.getProperty("/invoiceIdFilter")){i+=" and contains(InvoiceId,'"+a.getProperty("/invoiceIdFilter")+"')"}if(a.getProperty("/invDateFilter")){var r=(new Date).toISOString();switch(a.getProperty("/invDateFilter")){case"30days":var n=this._getDateInXDays(30);i+=" and (InvoiceDate_day ge "+r+" and InvoiceDate_day lt "+n+")";break;case"60days":var s=this._getDateInXDays(60);i+=" and (InvoiceDate_day ge "+r+" and InvoiceDate_day lt "+s+")";break;case"90days":var o=this._getDateInXDays(90);i+=" and (InvoiceDate_day ge "+r+" and InvoiceDate_day lt "+o+")";break;case"thisyear":var d=""+(new Date).getFullYear()+"-12-31T23:59:59.999Z";i+=" and (InvoiceDate_day ge "+r+" and InvoiceDate_day lt "+d+")";break}}if(a.getProperty("/statusFilter")){i+=" and ReconciliationStatus eq '"+a.getProperty("/statusFilter")+"'"}if(a.getProperty("/supplierIdFilter")){i+=" and Supplier_SupplierId eq '"+a.getProperty("/supplierIdFilter")+"'"}return i},onSearch:function(e){this.getView().getModel("oViewModel").setProperty("/busy",true);var t=this.getOwnerComponent().card,a=t.getCombinedParameters().searchResult;e.preventDefault();var r={sRealm:t.getCombinedParameters().realm,sFilter:this._getFilter(t),sParamUser:t.getCombinedParameters().user,bFilterOnUser:!!this.getView().getModel("oViewModel").getProperty("/createdByMeFilter"),sTop:a?"$top="+a:"",sOrderBy:"$orderby=InvoiceDate_day desc",sSelect:"$select=InvoiceId,Description,InvoiceDate_day,POId,Supplier_SupplierId,Commodity_CommodityId,ReconciliationStatus"};t.request({url:"{{destinations.wzcd}}/doSearchInvoices",dataType:"json",method:"POST",parameters:r,withCredentials:true,headers:{"Content-Type":"application/json",withCredentials:true}}).then(function(e){var t=this.getView().getModel("invoices");t.setData(e);t.refresh(true);this.getView().getModel("oViewModel").setProperty("/busy",false)}.bind(this)).catch(function(e){this.getView().getModel("oViewModel").setProperty("/busy",false);i.error("There was an error in retrieving data: "+e)}.bind(this))},_getDateInXDays:function(e){var t=new Date;return new Date(t.setDate(t.getDate()+e)).toISOString()},formatDate:function(e){return e&&e!=="1970-01-01T00:00:00Z"?e&&e.split("T")[0]:""},onListItemPress:function(e){var t=this.getOwnerComponent().card.getCombinedParameters().realm,i=this.getOwnerComponent().card.getCombinedParameters().datacenter,a=e.getSource().getBindingContext("invoices").getObject().InvoiceId;var r="https://"+i+".ariba.com/Buyer/Main/ad/webjumper?realm="+t+"&itemClassName=ariba.invoicing.core.InvoiceReconciliation&itemUniqueName="+a;sap.m.URLHelper.redirect(r,true)}})});